{% extends 'base.html' %}

{% block title %}{{ current_category|title }} ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ - ‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞{% endblock %}

{% block content %}
<!-- Hero Section -->
<div style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color);" class="py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-4xl md:text-6xl font-bold mb-4" style="color: var(--text-primary);">
            <i class="fas fa-{% if current_category == 'general' %}home{% elif current_category == 'business' %}briefcase{% elif current_category == 'sports' %}futbol{% elif current_category == 'technology' %}microchip{% elif current_category == 'politics' %}landmark{% else %}newspaper{% endif %} mr-4"></i>
            {% if current_category == 'general' %}‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø{% elif current_category == 'business' %}‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø{% elif current_category == 'national' %}‡§≠‡§æ‡§∞‡§§{% elif current_category == 'sports' %}‡§ñ‡•á‡§≤{% elif current_category == 'world' %}‡§¶‡•Å‡§®‡§ø‡§Ø‡§æ{% elif current_category == 'politics' %}‡§∞‡§æ‡§ú‡§®‡•Ä‡§§‡§ø{% elif current_category == 'technology' %}‡§§‡§ï‡§®‡•Ä‡§ï‡•Ä{% elif current_category == 'startup' %}‡§∏‡•ç‡§ü‡§æ‡§∞‡•ç‡§ü‡§Ö‡§™{% elif current_category == 'entertainment' %}‡§Æ‡§®‡•ã‡§∞‡§Ç‡§ú‡§®{% else %}{{ current_category }}{% endif %} ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞
        </h1>
        <p class="text-xl" style="color: var(--text-secondary);">‡§®‡§µ‡•Ä‡§®‡§§‡§Æ {{ current_category }} ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞‡•ã‡§Ç ‡§∏‡•á ‡§Ö‡§™‡§°‡•á‡§ü ‡§∞‡§π‡•á‡§Ç</p>
        <p class="mt-4 text-sm" style="color: var(--text-muted);">
            <i class="fas fa-clock mr-2"></i>{{ num_headlines }} ‡§≤‡•á‡§ñ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§ø‡§è ‡§ó‡§è
        </p>
    </div>
</div>

<!-- ‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Å -->
<div style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color);" class="sticky top-16 z-40">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
    <nav aria-label="Quick categories" class="flex gap-2 overflow-x-auto no-scrollbar">
      <a href="/hindi" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category|default:'general' == 'general' and current_language == 'hi' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category|default:'general' != 'general' or current_language != 'hi' %}border: 1px solid var(--border-color);{% endif %}">‡§ò‡§∞</a>
      <a href="/hindi/business" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'business' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'business' %}border: 1px solid var(--border-color);{% endif %}">‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø</a>
      <a href="/hindi/national" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'national' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'national' %}border: 1px solid var(--border-color);{% endif %}">‡§≠‡§æ‡§∞‡§§</a>
      <a href="/hindi/sports" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'sports' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'sports' %}border: 1px solid var(--border-color);{% endif %}">‡§ñ‡•á‡§≤</a>
      <a href="/hindi/world" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'world' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'world' %}border: 1px solid var(--border-color);{% endif %}">‡§¶‡•Å‡§®‡§ø‡§Ø‡§æ</a>
      <a href="/hindi/politics" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'politics' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'politics' %}border: 1px solid var(--border-color);{% endif %}">‡§∞‡§æ‡§ú‡§®‡•Ä‡§§‡§ø</a>
      <a href="/hindi/technology" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'technology' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'technology' %}border: 1px solid var(--border-color);{% endif %}">‡§§‡§ï‡§®‡•Ä‡§ï‡•Ä</a>
      <a href="/hindi/startup" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'startup' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'startup' %}border: 1px solid var(--border-color);{% endif %}">‡§∏‡•ç‡§ü‡§æ‡§∞‡•ç‡§ü‡§Ö‡§™</a>
      <a href="/hindi/entertainment" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'entertainment' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'entertainment' %}border: 1px solid var(--border-color);{% endif %}">‡§Æ‡§®‡•ã‡§∞‡§Ç‡§ú‡§®</a>
      <a href="/hindi/miscellaneous" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'miscellaneous' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'miscellaneous' %}border: 1px solid var(--border-color);{% endif %}">‡§µ‡§ø‡§µ‡§ø‡§ß</a>
    </nav>
  </div>
</div>

<!-- Featured/Preview Articles -->
{% if preview %}
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-4">
    <h2 class="text-2xl font-bold mb-6" style="color: var(--text-primary);">
        <i class="fas fa-star mr-2" style="color: #f59e0b;"></i>‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞
    </h2>
    <div class="grid md:grid-cols-3 gap-6">
        {% for headline in preview %}
        <div class="rounded-xl overflow-hidden transition hover:transform hover:scale-[1.02] cursor-pointer" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);" onclick="openArticleModal({
            title: '{{ headline.title|escapejs }}',
            content: '{{ headline.content|escapejs }}',
            img: '{{ headline.img|default:''|escapejs }}',
            date: '{{ headline.date|default:'‡§π‡§æ‡§≤ ‡§π‡•Ä ‡§Æ‡•á‡§Ç'|escapejs }}',
            leaning: '{{ headline.leaning }}',
            url: '{{ headline.url|escapejs }}'
        })">
            {% if headline.img %}
            <div class="relative h-48 overflow-hidden" style="background-color: var(--bg-hover);">
                <img src="{{ headline.img }}" alt="{{ headline.title }}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%231f1f1f\' width=\'400\' height=\'300\'/%3E%3Ctext fill=\'%236b6b6b\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\' font-family=\'sans-serif\' font-size=\'18\'%3E‡§ö‡§ø‡§§‡•ç‡§∞ ‡§®‡§π‡•Ä‡§Ç%3C/text%3E%3C/svg%3E'">
                <div class="absolute top-4 right-4">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold" style="background-color: var(--accent-blue); color: white;">
                        ‡§Æ‡•Å‡§ñ‡•ç‡§Ø
                    </span>
                </div>
            </div>
            {% endif %}
            <div class="p-6">
                <h3 class="text-xl font-bold mb-3 line-clamp-2" style="color: var(--text-primary);">{{ headline.title }}</h3>
                <p class="mb-4 line-clamp-3" style="color: var(--text-secondary);">{{ headline.content|slice:":150" }}...</p>
                <div class="flex items-center justify-between">
                    <span class="text-sm" style="color: var(--text-muted);">
                        <i class="fas fa-calendar mr-2"></i>{{ headline.date|default:"‡§π‡§æ‡§≤ ‡§π‡•Ä ‡§Æ‡•á‡§Ç" }}
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞ ‡§¨‡§æ‡§∞ -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6" id="main-content">
    <div class="rounded-xl p-3 md:p-4 flex flex-wrap items-center gap-3 md:gap-4 sticky top-32 z-30" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
        <div class="flex items-center gap-2">
            <span class="text-sm font-medium" style="color: var(--text-secondary);">‡§∞‡•Å‡§ù‡§æ‡§®:</span>
            <div class="flex overflow-x-auto no-scrollbar gap-2">
                <button class="px-3 py-1.5 rounded-full text-sm transition hover:bg-gray-700" style="background-color: var(--bg-tertiary); color: var(--text-primary);" data-lean-filter="all" onclick="setLeaningFilter('all')">‡§∏‡§≠‡•Ä</button>
                <button class="px-3 py-1.5 rounded-full text-sm transition hover:bg-blue-800" style="background-color: rgba(59, 130, 246, 0.2); color: #60a5fa;" data-lean-filter="left" onclick="setLeaningFilter('left')">‡§µ‡§æ‡§Æ</button>
                <button class="px-3 py-1.5 rounded-full text-sm transition hover:bg-green-800" style="background-color: rgba(34, 197, 94, 0.2); color: #4ade80;" data-lean-filter="center" onclick="setLeaningFilter('center')">‡§Æ‡§ß‡•ç‡§Ø</button>
                <button class="px-3 py-1.5 rounded-full text-sm transition hover:bg-rose-800" style="background-color: rgba(244, 63, 94, 0.2); color: #fb7185;" data-lean-filter="right" onclick="setLeaningFilter('right')">‡§¶‡§ï‡•ç‡§∑‡§ø‡§£</button>
            </div>
        </div>
        <div class="ml-auto flex items-center gap-2">
            <span class="text-sm font-medium" style="color: var(--text-secondary);">‡§¶‡•É‡§∂‡•ç‡§Ø:</span>
            <button id="view-grid" class="px-3 py-1.5 rounded-lg text-sm transition" style="background-color: var(--accent-blue); color: white;" onclick="setView('grid')" title="‡§ó‡•ç‡§∞‡§ø‡§°"><i class="fas fa-grip"></i></button>
            <button id="view-list" class="px-3 py-1.5 rounded-lg text-sm transition" style="background-color: var(--bg-tertiary); color: var(--text-primary);" onclick="setView('list')" title="‡§∏‡•Ç‡§ö‡•Ä"><i class="fas fa-list"></i></button>
        </div>
    </div>
</section>

<!-- ‡§∏‡§≠‡•Ä ‡§∏‡•Å‡§∞‡•ç‡§ñ‡§ø‡§Ø‡§æ‡§Å -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6 mb-12">
    <h2 class="text-2xl font-bold mb-6" style="color: var(--text-primary);">
        <i class="fas fa-newspaper mr-2"></i>‡§∏‡§≠‡•Ä ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞
    </h2>

    <!-- Grid Layout -->
    <div id="news-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {% for headline in headline_list %}
        <article class="rounded-xl overflow-hidden transition hover:transform hover:scale-[1.02]" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);" data-leaning="{{ headline.leaning }}">
            {% if headline.img %}
            <div class="relative h-52 overflow-hidden cursor-pointer" style="background-color: var(--bg-hover);" onclick="openArticleModal({
                title: '{{ headline.title|escapejs }}',
                content: '{{ headline.content|escapejs }}',
                img: '{{ headline.img|default:''|escapejs }}',
                date: '{{ headline.date|default:'‡§π‡§æ‡§≤ ‡§π‡•Ä ‡§Æ‡•á‡§Ç'|escapejs }}',
                leaning: '{{ headline.leaning }}',
                url: '{{ headline.url|escapejs }}'
            })">
                <img src="{{ headline.img }}" alt="{{ headline.title }}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%231f1f1f\' width=\'400\' height=\'300\'/%3E%3Ctext fill=\'%236b6b6b\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\' font-family=\'sans-serif\' font-size=\'18\'%3E‡§ö‡§ø‡§§‡•ç‡§∞ ‡§®‡§π‡•Ä‡§Ç%3C/text%3E%3C/svg%3E'">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
            </div>
            {% endif %}

            <div class="p-6 cursor-pointer" onclick="openArticleModal({
                title: '{{ headline.title|escapejs }}',
                content: '{{ headline.content|escapejs }}',
                img: '{{ headline.img|default:''|escapejs }}',
                date: '{{ headline.date|default:'‡§π‡§æ‡§≤ ‡§π‡•Ä ‡§Æ‡•á‡§Ç'|escapejs }}',
                leaning: '{{ headline.leaning }}',
                url: '{{ headline.url|escapejs }}'
            })">
                <h3 class="text-lg font-bold mb-3 transition line-clamp-2" style="color: var(--text-primary);">
                    {{ headline.title }}
                </h3>

                <p class="mb-4 text-sm line-clamp-3" style="color: var(--text-secondary);">
                    {{ headline.content }}
                </p>

                <div class="flex items-center justify-between pt-4" style="border-top: 1px solid var(--border-color);">
                    <div class="flex items-center gap-2">
                        <span class="text-xs" style="color: var(--text-muted);">
                            <i class="fas fa-clock mr-1"></i>{{ headline.date|default:"‡§π‡§æ‡§≤ ‡§π‡•Ä ‡§Æ‡•á‡§Ç" }}
                        </span>
                        <span class="text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full font-semibold"
                              {% if headline.leaning == 'left' %}
                                  style="background-color:rgba(59, 130, 246, 0.2);color:#60a5fa"
                              {% elif headline.leaning == 'center' %}
                                  style="background-color:rgba(34, 197, 94, 0.2);color:#4ade80"
                              {% else %}
                                  style="background-color:rgba(244, 63, 94, 0.2);color:#fb7185"
                              {% endif %}
                        >{% if headline.leaning == 'left' %}‡§µ‡§æ‡§Æ{% elif headline.leaning == 'center' %}‡§Æ‡§ß‡•ç‡§Ø{% else %}‡§¶‡§ï‡•ç‡§∑‡§ø‡§£{% endif %}</span>
                    </div>

                    <div class="flex items-center gap-3" onclick="event.stopPropagation()">
                        <a href="{{ headline.url }}" target="_blank" rel="noopener" aria-label="‡§≤‡•á‡§ñ ‡§ñ‡•ã‡§≤‡•á‡§Ç"
                           class="px-3 py-1.5 rounded-lg text-sm transition" style="background-color: var(--accent-blue); color: white;">‡§™‡§¢‡§º‡•á‡§Ç</a>
                        <button data-article-url="{{ headline.url }}" title="‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç" aria-pressed="false"
                                onclick="toggleBookmark({title: '{{ headline.title|escapejs }}', url: '{{ headline.url|escapejs }}', img: '{{ headline.img|default:''|escapejs }}', date: '{{ headline.date|default:'‡§π‡§æ‡§≤ ‡§π‡•Ä ‡§Æ‡•á‡§Ç'|escapejs }}', leaning: '{{ headline.leaning|escapejs }}'})"
                                class="transition hover:text-yellow-500" style="color: var(--text-muted);">
                            <i class="fas fa-bookmark"></i>
                        </button>
                        <button onclick="shareArticle('{{ headline.title|escapejs }}', '{{ headline.url|escapejs }}')" class="transition hover:text-blue-400" style="color: var(--text-muted);" title="‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </article>
        {% endfor %}
    </div>

    <!-- ‡§á‡§®‡•ç‡§´‡§ø‡§®‡§ø‡§ü ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤ ‡§∏‡•á‡§Ç‡§ü‡§ø‡§®‡§≤ -->
    <div id="infinite-scroll-sentinel" class="h-8"></div>

    <!-- Load More Button -->
    {% if headline_list %}
    <div class="text-center mt-12">
        <button id="load-more-btn" onclick="loadMoreNews()" class="font-semibold px-8 py-4 rounded-xl transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: var(--accent-blue); color: white;">
            <i class="fas fa-sync-alt mr-2"></i>
            <span id="load-more-text">‡§î‡§∞ ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</span>
        </button>
        <div id="load-more-loading" class="hidden mt-4">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: var(--accent-blue);"></div>
            <p class="mt-2" style="color: var(--text-secondary);">‡§Ö‡§ß‡§ø‡§ï ‡§≤‡•á‡§ñ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...</p>
        </div>
    </div>
    {% endif %}

    <!-- Empty State -->
    {% if not headline_list %}
    <div class="text-center py-16">
        <div class="inline-block p-8 rounded-full mb-4" style="background-color: var(--bg-tertiary);">
            <i class="fas fa-newspaper text-6xl" style="color: var(--text-muted);"></i>
        </div>
        <h3 class="text-2xl font-bold mb-2" style="color: var(--text-primary);">‡§ï‡•ã‡§à ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç</h3>
        <p style="color: var(--text-secondary);">‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡•á ‡§≤‡§ø‡§è ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§¶‡•á‡§ñ‡•á‡§Ç</p>
    </div>
    {% endif %}
</section>

<!-- Article Modal -->
<div id="articleModal" class="fixed inset-0 z-50 hidden" style="background-color: rgba(0, 0, 0, 0.8);" onclick="if(event.target === this) closeArticleModal()">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-xl" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
            <!-- Close Button -->
            <button onclick="closeArticleModal()" class="absolute top-4 right-4 z-10 w-10 h-10 rounded-full flex items-center justify-center transition hover:bg-red-600" style="background-color: rgba(0, 0, 0, 0.5); color: white;">
                <i class="fas fa-times"></i>
            </button>

            <!-- Article Image -->
            <div id="modal-image-container" class="relative h-64 md:h-80 overflow-hidden" style="background-color: var(--bg-hover);">
                <img id="modal-image" src="" alt="" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
            </div>

            <!-- Article Content -->
            <div class="p-6 md:p-8">
                <!-- Title -->
                <h2 id="modal-title" class="text-2xl md:text-3xl font-bold mb-4" style="color: var(--text-primary);"></h2>

                <!-- Meta Info -->
                <div class="flex items-center gap-4 mb-6 pb-4" style="border-bottom: 1px solid var(--border-color);">
                    <span id="modal-date" class="text-sm" style="color: var(--text-muted);">
                        <i class="fas fa-calendar mr-2"></i>
                    </span>
                    <span id="modal-leaning" class="text-xs uppercase tracking-wide px-3 py-1 rounded-full font-semibold"></span>
                </div>

                <!-- Full Content -->
                <div id="modal-content" class="text-base md:text-lg leading-relaxed mb-6" style="color: var(--text-secondary);"></div>

                <!-- Action Buttons -->
                <div class="flex items-center gap-4 pt-6" style="border-top: 1px solid var(--border-color);">
                    <button onclick="shareArticleFromModal()" class="px-6 py-3 rounded-lg font-semibold transition hover:bg-gray-700" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                        <i class="fas fa-share-alt mr-2"></i>‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Current page for Load More functionality
let currentPage = 1;
const currentCategory = '{{ current_category }}';
const currentLanguage = '{{ current_language }}';
let currentLeaningFilter = 'all';
let currentView = localStorage.getItem('news_view_mode') || 'grid';

// Load More News functionality
async function loadMoreNews() {
    const btn = document.getElementById('load-more-btn');
    const loading = document.getElementById('load-more-loading');
    const newsGrid = document.getElementById('news-grid');

    // Disable button and show loading
    btn.disabled = true;
    loading.classList.remove('hidden');

    try {
        currentPage += 1;
        const response = await fetch(`/api/load-more/?category=${currentCategory}&language=${currentLanguage}&page=${currentPage}`);
        const data = await response.json();

        if (data.articles && data.articles.length > 0) {
            // Append new articles
            data.articles.forEach(article => {
                const articleHTML = createArticleCard2(article);
                newsGrid.insertAdjacentHTML('beforeend', articleHTML);
            });

            // Animate new cards
            setTimeout(() => {
                const newCards = newsGrid.querySelectorAll('article:nth-last-child(-n+' + data.articles.length + ')');
                newCards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px)';
                        setTimeout(() => {
                            card.style.transition = 'all 0.5s ease';
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        }, 50);
                    }, index * 100);
                });
            }, 100);

            // Hide button if no more pages
            if (!data.has_next) {
                btn.style.display = 'none';
                loading.innerHTML = '<p style="color: var(--text-secondary);">‡§Ü‡§™ ‡§Ö‡§Ç‡§§ ‡§§‡§ï ‡§™‡§π‡•Å‡§Ç‡§ö ‡§ó‡§è ‡§π‡•à‡§Ç! üéâ</p>';
                setTimeout(() => loading.classList.add('hidden'), 3000);
            } else {
                btn.disabled = false;
            }
        } else {
            btn.style.display = 'none';
            loading.innerHTML = '<p style="color: var(--text-secondary);">‡§Ö‡§ß‡§ø‡§ï ‡§≤‡•á‡§ñ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡§Ç</p>';
        }
    } catch (error) {
        console.error('Error loading more news:', error);
        btn.disabled = false;
        alert('‡§Ö‡§ß‡§ø‡§ï ‡§∏‡§Æ‡§æ‡§ö‡§æ‡§∞ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§´‡§≤‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§');
    } finally {
        loading.classList.add('hidden');
        updateBookmarkIcons();
    }
}

// Create article card HTML
function createArticleCard2(article) {
    const articleJSON = JSON.stringify({
        title: article.title,
        content: article.content,
        img: article.img || '',
        date: article.date,
        leaning: article.leaning,
        url: article.url
    }).replace(/"/g, '&quot;');

    const imgHTML = article.img ? `
        <div class="relative h-52 overflow-hidden cursor-pointer" style="background-color: var(--bg-hover);" onclick='openArticleModal(${articleJSON})'>
            <img src="${article.img}" alt="${article.title}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'400\\' height=\\'300\\'%3E%3Crect fill=\\'%231f1f1f\\' width=\\'400\\' height=\\'300\\'/%3E%3Ctext fill=\\'%236b6b6b\\' x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dominant-baseline=\\'middle\\' font-family=\\'sans-serif\\' font-size=\\'18\\'%3E‡§ö‡§ø‡§§‡•ç‡§∞ ‡§®‡§π‡•Ä‡§Ç%3C/text%3E%3C/svg%3E'">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
        </div>
    ` : '';

    const leaningStyle = article.leaning === 'left'
        ? 'background-color:rgba(59, 130, 246, 0.2);color:#60a5fa'
        : article.leaning === 'center'
            ? 'background-color:rgba(34, 197, 94, 0.2);color:#4ade80'
            : 'background-color:rgba(244, 63, 94, 0.2);color:#fb7185';

    const leaningText = article.leaning === 'left' ? '‡§µ‡§æ‡§Æ' : article.leaning === 'center' ? '‡§Æ‡§ß‡•ç‡§Ø' : '‡§¶‡§ï‡•ç‡§∑‡§ø‡§£';

    return `
        <article class="rounded-xl overflow-hidden transition hover:transform hover:scale-[1.02]" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);" data-leaning="${article.leaning}">
            ${imgHTML}
            <div class="p-6 cursor-pointer" onclick='openArticleModal(${articleJSON})'>
                <h3 class="text-lg font-bold mb-3 transition line-clamp-2" style="color: var(--text-primary);">
                    ${article.title}
                </h3>
                <p class="mb-4 text-sm line-clamp-3" style="color: var(--text-secondary);">
                    ${article.content}
                </p>
                <div class="flex items-center justify-between pt-4" style="border-top: 1px solid var(--border-color);">
                    <div class="flex items-center gap-2">
                        <span class="text-xs" style="color: var(--text-muted);">
                            <i class="fas fa-clock mr-1"></i>${article.date}
                        </span>
                        <span class="text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full font-semibold" style="${leaningStyle}">${leaningText}</span>
                    </div>
                    <div class="flex items-center gap-3" onclick="event.stopPropagation()">
                        <a href="${article.url}" target="_blank" rel="noopener" aria-label="‡§≤‡•á‡§ñ ‡§ñ‡•ã‡§≤‡•á‡§Ç" class="px-3 py-1.5 rounded-lg text-sm transition" style="background-color: var(--accent-blue); color: white;">‡§™‡§¢‡§º‡•á‡§Ç</a>
                        <button data-article-url="${article.url}" title="‡§¨‡•Å‡§ï‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç" aria-pressed="false"
                                onclick="toggleBookmark({title: '${article.title.replace(/'/g, "\\'")}', url: '${article.url}', img: '${article.img || ''}', date: '${article.date}', leaning: '${article.leaning}'})"
                                class="transition hover:text-yellow-500" style="color: var(--text-muted);">
                            <i class="fas fa-bookmark"></i>
                        </button>
                        <button onclick="shareArticle('${article.title.replace(/'/g, "\\'")}', '${article.url}')" class="transition hover:text-blue-400" style="color: var(--text-muted);" title="‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </article>
    `;
}

// Share functionality
function shareArticle(title, url) {
    if (navigator.share) {
        navigator.share({
            title: title,
            url: url || window.location.href
        }).catch(err => console.log('Error sharing:', err));
    } else {
        const tempInput = document.createElement('input');
        tempInput.value = window.location.href;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        alert('‡§≤‡§ø‡§Ç‡§ï ‡§ï‡•â‡§™‡•Ä ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!');
    }
}

// Intersection Observer for lazy loading images
const imageObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const img = entry.target;
            if (img.dataset.src) {
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
            }
            observer.unobserve(img);
        }
    });
});

document.querySelectorAll('img[data-src]').forEach(img => imageObserver.observe(img));

// ‡§∞‡•Å‡§ù‡§æ‡§® ‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞
function applyLeaningFilter() {
    const grid = document.getElementById('news-grid');
    if (!grid) return;
    const items = grid.querySelectorAll('article');
    items.forEach(card => {
        const lean = card.getAttribute('data-leaning');
        const match = (currentLeaningFilter === 'all') || (lean === currentLeaningFilter);
        card.style.display = match ? '' : 'none';
    });
}
function updateLeaningControls() {
    document.querySelectorAll('[data-lean-filter]').forEach(btn => {
        const active = btn.getAttribute('data-lean-filter') === currentLeaningFilter;
        btn.classList.toggle('ring-2', active);
        btn.classList.toggle('ring-offset-2', active);
        btn.classList.toggle('ring-blue-500', active);
    });
}
function setLeaningFilter(val) {
    currentLeaningFilter = val;
    applyLeaningFilter();
    updateLeaningControls();
}

// ‡§¶‡•É‡§∂‡•ç‡§Ø ‡§ü‡•â‡§ó‡§≤
function setView(mode) {
    currentView = mode;
    localStorage.setItem('news_view_mode', mode);
    const grid = document.getElementById('news-grid');
    if (!grid) return;
    if (mode === 'list') {
        grid.classList.remove('md:grid-cols-2','lg:grid-cols-3');
        grid.classList.add('grid-cols-1');
    } else {
        grid.classList.add('md:grid-cols-2','lg:grid-cols-3');
        grid.classList.remove('grid-cols-1');
    }
    const gridBtn = document.getElementById('view-grid');
    const listBtn = document.getElementById('view-list');
    if (mode === 'grid') {
        gridBtn.style.backgroundColor = 'var(--accent-blue)';
        gridBtn.style.color = 'white';
        listBtn.style.backgroundColor = 'var(--bg-tertiary)';
        listBtn.style.color = 'var(--text-primary)';
    } else {
        listBtn.style.backgroundColor = 'var(--accent-blue)';
        listBtn.style.color = 'white';
        gridBtn.style.backgroundColor = 'var(--bg-tertiary)';
        gridBtn.style.color = 'var(--text-primary)';
    }
}

// ‡§á‡§®‡•ç‡§´‡§ø‡§®‡§ø‡§ü ‡§∏‡•ç‡§ï‡•ç‡§∞‡•â‡§≤
let io;
function setupInfiniteScroll() {
    const sentinel = document.getElementById('infinite-scroll-sentinel');
    const btn = document.getElementById('load-more-btn');
    if (!('IntersectionObserver' in window) || !sentinel) { btn.classList.remove('hidden'); return; }
    io = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                loadMoreNews();
            }
        })
    }, { rootMargin: '200px' });
    io.observe(sentinel);
    btn.classList.add('hidden');
}

// Article Modal Functions
let currentArticle = null;

function openArticleModal(article) {
    currentArticle = article;

    // Set title
    document.getElementById('modal-title').textContent = article.title;

    // Set date
    document.getElementById('modal-date').innerHTML = `<i class="fas fa-calendar mr-2"></i>${article.date || '‡§π‡§æ‡§≤ ‡§π‡•Ä ‡§Æ‡•á‡§Ç'}`;

    // Set leaning badge
    const leaningBadge = document.getElementById('modal-leaning');
    if (article.leaning === 'left') {
        leaningBadge.textContent = '‡§µ‡§æ‡§Æ';
        leaningBadge.style.cssText = 'background-color:rgba(59, 130, 246, 0.2);color:#60a5fa';
    } else if (article.leaning === 'center') {
        leaningBadge.textContent = '‡§Æ‡§ß‡•ç‡§Ø';
        leaningBadge.style.cssText = 'background-color:rgba(34, 197, 94, 0.2);color:#4ade80';
    } else {
        leaningBadge.textContent = '‡§¶‡§ï‡•ç‡§∑‡§ø‡§£';
        leaningBadge.style.cssText = 'background-color:rgba(244, 63, 94, 0.2);color:#fb7185';
    }

    // Set content
    document.getElementById('modal-content').textContent = article.content;

    // Set image
    const imageContainer = document.getElementById('modal-image-container');
    const image = document.getElementById('modal-image');
    if (article.img) {
        image.src = article.img;
        image.alt = article.title;
        imageContainer.style.display = 'block';
    } else {
        imageContainer.style.display = 'none';
    }

    // Show modal
    document.getElementById('articleModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeArticleModal() {
    document.getElementById('articleModal').classList.add('hidden');
    document.body.style.overflow = '';
}

function shareArticleFromModal() {
    if (currentArticle) {
        shareArticle(currentArticle.title, currentArticle.url);
    }
}

// ESC key to close modal
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeArticleModal();
    }
});

// ‡§™‡•ç‡§∞‡§æ‡§∞‡§Ç‡§≠
document.addEventListener('DOMContentLoaded', () => {
    setView(currentView);
    updateLeaningControls();
    setupInfiniteScroll();
    if (typeof updateBookmarkIcons === 'function') updateBookmarkIcons();
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}
