{% extends 'base.html' %}

{% block title %}{{ current_category|title }} News - QuickNews{% endblock %}

{% block content %}
<!-- Hero Section -->
<div style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color);" class="py-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-4xl md:text-6xl font-bold mb-4" style="color: var(--text-primary);">
            <i class="fas fa-{% if current_category == 'general' %}home{% elif current_category == 'business' %}briefcase{% elif current_category == 'sports' %}futbol{% elif current_category == 'technology' %}microchip{% elif current_category == 'politics' %}landmark{% else %}newspaper{% endif %} mr-4"></i>
            {{ current_category|title }} News
        </h1>
        <p class="text-xl" style="color: var(--text-secondary);">Stay updated with the latest {{ current_category }} headlines</p>
        <p class="mt-4 text-sm" style="color: var(--text-muted);">
            <i class="fas fa-clock mr-2"></i>Updated {{ num_headlines }} articles
        </p>
    </div>
</div>

<!-- Quick Categories -->
<div style="background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color);" class="sticky top-16 z-40">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
    <nav aria-label="Quick categories" class="flex gap-2 overflow-x-auto no-scrollbar">
      <a href="/" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category|default:'general' == 'general' and current_language != 'hi' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category|default:'general' != 'general' or current_language == 'hi' %}border: 1px solid var(--border-color);{% endif %}">Home</a>
      <a href="/business" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'business' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'business' %}border: 1px solid var(--border-color);{% endif %}">Business</a>
      <a href="/national" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'national' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'national' %}border: 1px solid var(--border-color);{% endif %}">National</a>
      <a href="/sports" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'sports' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'sports' %}border: 1px solid var(--border-color);{% endif %}">Sports</a>
      <a href="/world" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'world' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'world' %}border: 1px solid var(--border-color);{% endif %}">World</a>
      <a href="/politics" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'politics' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'politics' %}border: 1px solid var(--border-color);{% endif %}">Politics</a>
      <a href="/technology" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'technology' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'technology' %}border: 1px solid var(--border-color);{% endif %}">Technology</a>
      <a href="/startup" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'startup' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'startup' %}border: 1px solid var(--border-color);{% endif %}">Startup</a>
      <a href="/entertainment" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'entertainment' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'entertainment' %}border: 1px solid var(--border-color);{% endif %}">Entertainment</a>
      <a href="/miscellaneous" class="px-3 py-1.5 rounded-full text-sm transition {% if current_category == 'miscellaneous' %}bg-blue-600 text-white{% else %}text-gray-300 hover:text-white hover:bg-gray-700{% endif %}" style="{% if current_category != 'miscellaneous' %}border: 1px solid var(--border-color);{% endif %}">Misc</a>
    </nav>
  </div>
</div>

<!-- Featured/Preview Articles -->
{% if preview %}
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-4">
    <h2 class="text-2xl font-bold mb-6" style="color: var(--text-primary);">
        <i class="fas fa-star mr-2" style="color: #f59e0b;"></i>Featured Stories
    </h2>
    <div class="grid md:grid-cols-3 gap-6">
        {% for headline in preview %}
        <div class="rounded-xl overflow-hidden transition hover:transform hover:scale-[1.02] cursor-pointer" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);" onclick="openArticleModal({
                title: '{{ headline.title|escapejs }}',
                content: '{{ headline.content|escapejs }}',
                img: '{{ headline.img|default:''|escapejs }}',
                date: '{{ headline.date|default:'Recent'|escapejs }}',
                leaning: '{{ headline.leaning }}',
                url: '{{ headline.url|escapejs }}'
            })">
            {% if headline.img %}
            <div class="relative h-48 overflow-hidden" style="background-color: var(--bg-hover);">
                <img src="{{ headline.img }}" alt="{{ headline.title }}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%231f1f1f\' width=\'400\' height=\'300\'/%3E%3Ctext fill=\'%236b6b6b\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\' font-family=\'sans-serif\' font-size=\'18\'%3ENo Image%3C/text%3E%3C/svg%3E'">
                <div class="absolute top-4 right-4">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold" style="background-color: var(--accent-blue); color: white;">
                        Featured
                    </span>
                </div>
            </div>
            {% endif %}
            <div class="p-6">
                <h3 class="text-xl font-bold mb-3 line-clamp-2" style="color: var(--text-primary);">{{ headline.title }}</h3>
                <p class="mb-4 line-clamp-3" style="color: var(--text-secondary);">{{ headline.content|slice:":150" }}...</p>
                <div class="flex items-center justify-between">
                    <span class="text-sm" style="color: var(--text-muted);">
                        <i class="fas fa-calendar mr-2"></i>{{ headline.date|default:"Recent" }}
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Filters Bar -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6" id="main-content">
    <div class="rounded-xl p-3 md:p-4 flex flex-wrap items-center gap-3 md:gap-4 sticky top-32 z-30" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
        <div class="flex items-center gap-2">
            <span class="text-sm font-medium" style="color: var(--text-secondary);">Leaning:</span>
            <div class="flex overflow-x-auto no-scrollbar gap-2">
                <button class="px-3 py-1.5 rounded-full text-sm transition hover:bg-gray-700" style="background-color: var(--bg-tertiary); color: var(--text-primary);" data-lean-filter="all" onclick="setLeaningFilter('all')">All</button>
                <button class="px-3 py-1.5 rounded-full text-sm transition hover:bg-blue-800" style="background-color: rgba(59, 130, 246, 0.2); color: #60a5fa;" data-lean-filter="left" onclick="setLeaningFilter('left')">Left</button>
                <button class="px-3 py-1.5 rounded-full text-sm transition hover:bg-green-800" style="background-color: rgba(34, 197, 94, 0.2); color: #4ade80;" data-lean-filter="center" onclick="setLeaningFilter('center')">Center</button>
                <button class="px-3 py-1.5 rounded-full text-sm transition hover:bg-rose-800" style="background-color: rgba(244, 63, 94, 0.2); color: #fb7185;" data-lean-filter="right" onclick="setLeaningFilter('right')">Right</button>
            </div>
        </div>
        <div class="ml-auto flex items-center gap-2">
            <span class="text-sm font-medium" style="color: var(--text-secondary);">View:</span>
            <button id="view-grid" class="px-3 py-1.5 rounded-lg text-sm transition" style="background-color: var(--accent-blue); color: white;" onclick="setView('grid')" title="Grid view"><i class="fas fa-grip"></i></button>
            <button id="view-list" class="px-3 py-1.5 rounded-lg text-sm transition" style="background-color: var(--bg-tertiary); color: var(--text-primary);" onclick="setView('list')" title="List view"><i class="fas fa-list"></i></button>
        </div>
    </div>
</section>

<!-- All Headlines -->
<section class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6 mb-12">
    <h2 class="text-2xl font-bold mb-6" style="color: var(--text-primary);">
        <i class="fas fa-newspaper mr-2"></i>All Headlines
    </h2>

    <!-- Grid Layout -->
    <div id="news-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {% for headline in headline_list %}
        <article class="rounded-xl overflow-hidden transition hover:transform hover:scale-[1.02]" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);" data-leaning="{{ headline.leaning }}">
            {% if headline.img %}
            <div class="relative h-52 overflow-hidden" style="background-color: var(--bg-hover);">
                <img src="{{ headline.img }}" alt="{{ headline.title }}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'300\'%3E%3Crect fill=\'%231f1f1f\' width=\'400\' height=\'300\'/%3E%3Ctext fill=\'%236b6b6b\' x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dominant-baseline=\'middle\' font-family=\'sans-serif\' font-size=\'18\'%3ENo Image%3C/text%3E%3C/svg%3E'">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
            </div>
            {% endif %}

            <div class="p-6 cursor-pointer" onclick="openArticleModal({
                title: '{{ headline.title|escapejs }}',
                content: '{{ headline.content|escapejs }}',
                img: '{{ headline.img|default:''|escapejs }}',
                date: '{{ headline.date|default:'Recently'|escapejs }}',
                leaning: '{{ headline.leaning }}',
                url: '{{ headline.url|escapejs }}'
            })">
                <h3 class="text-lg font-bold mb-3 transition line-clamp-2 hover:text-blue-400" style="color: var(--text-primary);">
                    {{ headline.title }}
                </h3>

                <p class="mb-4 text-sm line-clamp-3" style="color: var(--text-secondary);">
                    {{ headline.content }}
                </p>

                <div class="flex items-center justify-between pt-4" style="border-top: 1px solid var(--border-color);">
                    <div class="flex items-center gap-2">
                        <span class="text-xs" style="color: var(--text-muted);">
                            <i class="fas fa-clock mr-1"></i>{{ headline.date|default:"Recently" }}
                        </span>
                        <span class="text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full font-semibold"
                              {% if headline.leaning == 'left' %}
                                  style="background-color:rgba(59, 130, 246, 0.2);color:#60a5fa"
                              {% elif headline.leaning == 'center' %}
                                  style="background-color:rgba(34, 197, 94, 0.2);color:#4ade80"
                              {% else %}
                                  style="background-color:rgba(244, 63, 94, 0.2);color:#fb7185"
                              {% endif %}
                        >{{ headline.leaning }}</span>
                    </div>

                    <div class="flex items-center gap-3" onclick="event.stopPropagation()">
                        <button data-article-url="{{ headline.url }}" title="Save bookmark" aria-pressed="false"
                                onclick="toggleBookmark({title: '{{ headline.title|escapejs }}', url: '{{ headline.url|escapejs }}', img: '{{ headline.img|default:''|escapejs }}', date: '{{ headline.date|default:'Recently'|escapejs }}', leaning: '{{ headline.leaning|escapejs }}'})"
                                class="transition hover:text-yellow-500" style="color: var(--text-muted);">
                            <i class="fas fa-bookmark"></i>
                        </button>
                        <button onclick="shareArticle('{{ headline.title|escapejs }}', '{{ headline.url|escapejs }}')" class="transition hover:text-blue-400" style="color: var(--text-muted);" title="Share">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </article>
        {% endfor %}
    </div>

    <!-- Infinite scroll sentinel -->
    <div id="infinite-scroll-sentinel" class="h-8"></div>

    <!-- Load More Button -->
    {% if headline_list %}
    <div class="text-center mt-12">
        <button id="load-more-btn" onclick="loadMoreNews()" class="font-semibold px-8 py-4 rounded-xl transition transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: var(--accent-blue); color: white;">
            <i class="fas fa-sync-alt mr-2"></i>
            <span id="load-more-text">Load More News</span>
        </button>
        <div id="load-more-loading" class="hidden mt-4">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2" style="border-color: var(--accent-blue);"></div>
            <p class="mt-2" style="color: var(--text-secondary);">Loading more articles...</p>
        </div>
    </div>
    {% endif %}

    <!-- Empty State -->
    {% if not headline_list %}
    <div class="text-center py-16">
        <div class="inline-block p-8 rounded-full mb-4" style="background-color: var(--bg-tertiary);">
            <i class="fas fa-newspaper text-6xl" style="color: var(--text-muted);"></i>
        </div>
        <h3 class="text-2xl font-bold mb-2" style="color: var(--text-primary);">No News Available</h3>
        <p style="color: var(--text-secondary);">Check back later for updates</p>
    </div>
    {% endif %}
</section>

<!-- Loading Skeletons (hidden by default, shown via JS when loading) -->
<div id="loading-skeletons" class="hidden max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-16 mb-12">
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {% for i in "123456" %}
        <div class="rounded-xl overflow-hidden" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);">
            <div class="skeleton h-52"></div>
            <div class="p-6 space-y-3">
                <div class="skeleton h-6 rounded"></div>
                <div class="skeleton h-4 rounded w-4/5"></div>
                <div class="skeleton h-4 rounded w-3/5"></div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Article Modal -->
<div id="articleModal" class="fixed inset-0 z-50 hidden" style="background-color: rgba(0, 0, 0, 0.8);">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="relative w-full max-w-4xl max-h-[90vh] overflow-y-auto rounded-xl" style="background-color: var(--bg-secondary); border: 1px solid var(--border-color);">
            <!-- Close Button -->
            <button onclick="closeArticleModal()" class="absolute top-4 right-4 z-10 w-10 h-10 rounded-full flex items-center justify-center transition hover:bg-gray-700" style="background-color: var(--bg-tertiary);">
                <i class="fas fa-times" style="color: var(--text-primary);"></i>
            </button>

            <!-- Modal Content -->
            <div class="p-6 md:p-8">
                <!-- Article Image -->
                <div id="modal-image-container" class="hidden mb-6 rounded-xl overflow-hidden" style="max-height: 400px;">
                    <img id="modal-image" src="" alt="" class="w-full h-full object-cover">
                </div>

                <!-- Article Title -->
                <h2 id="modal-title" class="text-3xl md:text-4xl font-bold mb-4" style="color: var(--text-primary);"></h2>

                <!-- Article Meta -->
                <div class="flex flex-wrap items-center gap-4 mb-6 pb-6" style="border-bottom: 1px solid var(--border-color);">
                    <span id="modal-date" class="text-sm" style="color: var(--text-muted);">
                        <i class="fas fa-calendar mr-2"></i>
                    </span>
                    <span id="modal-leaning" class="text-xs uppercase tracking-wide px-3 py-1 rounded-full font-semibold"></span>
                </div>

                <!-- Article Content -->
                <div id="modal-content" class="text-lg leading-relaxed mb-8" style="color: var(--text-secondary);"></div>

                <!-- Action Buttons -->
                <div class="flex gap-4 pt-6" style="border-top: 1px solid var(--border-color);">
                    <button id="modal-share" onclick="shareArticleFromModal()" class="px-6 py-3 rounded-lg font-semibold transition" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                        <i class="fas fa-share-alt mr-2"></i>
                        Share
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Current article data for modal
let currentArticle = null;

// Open article modal
function openArticleModal(article) {
    currentArticle = article;

    // Set title
    document.getElementById('modal-title').textContent = article.title;

    // Set date
    document.getElementById('modal-date').innerHTML = '<i class="fas fa-calendar mr-2"></i>' + article.date;

    // Set leaning badge
    const leaningBadge = document.getElementById('modal-leaning');
    leaningBadge.textContent = article.leaning;
    if (article.leaning === 'left') {
        leaningBadge.style.backgroundColor = 'rgba(59, 130, 246, 0.2)';
        leaningBadge.style.color = '#60a5fa';
    } else if (article.leaning === 'center') {
        leaningBadge.style.backgroundColor = 'rgba(34, 197, 94, 0.2)';
        leaningBadge.style.color = '#4ade80';
    } else {
        leaningBadge.style.backgroundColor = 'rgba(244, 63, 94, 0.2)';
        leaningBadge.style.color = '#fb7185';
    }

    // Set content
    document.getElementById('modal-content').textContent = article.content;

    // Set image if exists
    const imageContainer = document.getElementById('modal-image-container');
    if (article.img) {
        document.getElementById('modal-image').src = article.img;
        imageContainer.classList.remove('hidden');
    } else {
        imageContainer.classList.add('hidden');
    }

    // Show modal
    document.getElementById('articleModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

// Close article modal
function closeArticleModal() {
    document.getElementById('articleModal').classList.add('hidden');
    document.body.style.overflow = '';
}

// Share article from modal
function shareArticleFromModal() {
    if (currentArticle) {
        shareArticle(currentArticle.title, currentArticle.url);
    }
}

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeArticleModal();
    }
});

// Close modal when clicking outside
document.getElementById('articleModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeArticleModal();
    }
});

// Current page for Load More functionality
let currentPage = 1;
const currentCategory = '{{ current_category }}';
const currentLanguage = '{{ current_language }}';
let currentLeaningFilter = 'all';
let currentView = localStorage.getItem('news_view_mode') || 'grid';

// Load More News functionality
async function loadMoreNews() {
    const btn = document.getElementById('load-more-btn');
    const loading = document.getElementById('load-more-loading');
    const newsGrid = document.getElementById('news-grid');

    // Disable button and show loading
    btn.disabled = true;
    loading.classList.remove('hidden');

    try {
        currentPage += 1;
        const response = await fetch(`/api/load-more/?category=${currentCategory}&language=${currentLanguage}&page=${currentPage}`);
        const data = await response.json();

        if (data.articles && data.articles.length > 0) {
            // Append new articles
            data.articles.forEach(article => {
                const articleHTML = createArticleCard2(article);
                newsGrid.insertAdjacentHTML('beforeend', articleHTML);
            });

            // Animate new cards
            setTimeout(() => {
                const newCards = newsGrid.querySelectorAll('article:nth-last-child(-n+' + data.articles.length + ')');
                newCards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px)';
                        setTimeout(() => {
                            card.style.transition = 'all 0.5s ease';
                            card.style.opacity = '1';
                            card.style.transform = 'translateY(0)';
                        }, 50);
                    }, index * 100);
                });
            }, 100);

            // Hide button if no more pages
            if (!data.has_next) {
                btn.style.display = 'none';
                loading.innerHTML = '<p class="text-gray-600 dark:text-gray-400">You\'ve reached the end! ðŸŽ‰</p>';
                setTimeout(() => loading.classList.add('hidden'), 3000);
            } else {
                btn.disabled = false;
            }
        } else {
            btn.style.display = 'none';
            loading.innerHTML = '<p class="text-gray-600 dark:text-gray-400">No more articles available</p>';
        }
    } catch (error) {
        console.error('Error loading more news:', error);
        btn.disabled = false;
        alert('Failed to load more news. Please try again.');
    } finally {
        loading.classList.add('hidden');
        updateBookmarkIcons();
    }
}

// Create article card HTML
function createArticleCard(article) {
    const imgHTML = article.img ? `
        <div class="relative h-52 bg-gray-200 dark:bg-gray-700 overflow-hidden">
            <img src="${article.img}" alt="${article.title}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'400\\' height=\\'300\\'%3E%3Crect fill=\\'%23ddd\\' width=\\'400\\' height=\\'300\\'/%3E%3Ctext fill=\\'%23999\\' x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dominant-baseline=\\'middle\\' font-family=\\'sans-serif\\' font-size=\\'18\\'%3ENo Image%3C/text%3E%3C/svg%3E'">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
        </div>
    ` : '';

    return `
        <article class="bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-lg card-hover" data-leaning="${article.leaning}">
            ${imgHTML}
            <div class="p-6">
                <h3 class="text-lg font-bold mb-3 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition line-clamp-2">
                    <a href="${article.url}" target="_blank" rel="noopener">${article.title}</a>
                </h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4 text-sm line-clamp-3">
                    ${article.content}
                </p>
                <div class="flex items-center justify-between pt-4 border-t dark:border-gray-700">
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500 dark:text-gray-500">
                            <i class="fas fa-clock mr-1"></i>${article.date}
                        </span>
                        <span class="text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full font-semibold ${article.leaning==='left' ? 'bg-blue-50 text-blue-700' : article.leaning==='center' ? 'bg-green-50 text-green-700' : 'bg-rose-50 text-rose-700'}">${article.leaning}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <a href="${article.url}" target="_blank" rel="noopener" aria-label="Open article" class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-sm hover:bg-blue-700">Read</a>
                        <button data-article-url="${article.url}" title="Save bookmark" aria-pressed="false"
                                onclick="toggleBookmark({title: '${'${'}article.title.replace(/'/g, "\\'")}', url: '${'${'}article.url}', img: '${'${'}article.img || ''}', date: '${'${'}article.date}', leaning: '${'${'}article.leaning}'})"
                                class="text-gray-400 hover:text-yellow-500 transition">
                            <i class="fas fa-bookmark"></i>
                        </button>
                        <button onclick="shareArticle('${'${'}article.title.replace(/'/g, "\\'")}', '${'${'}article.url}')}" class="text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition" title="Share">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </article>
    `;
}

// Fixed version with correct template placeholders
function createArticleCard2(article) {
    const imgHTML = article.img ? `
        <div class="relative h-52 overflow-hidden" style="background-color: var(--bg-hover);">
            <img src="${article.img}" alt="${article.title}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'400\\' height=\\'300\\'%3E%3Crect fill=\\'%231f1f1f\\' width=\\'400\\' height=\\'300\\'/%3E%3Ctext fill=\\'%236b6b6b\\' x=\\'50%25\\' y=\\'50%25\\' text-anchor=\\'middle\\' dominant-baseline=\\'middle\\' font-family=\\'sans-serif\\' font-size=\\'18\\'%3ENo Image%3C/text%3E%3C/svg%3E'">
            <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
        </div>
    ` : '';

    const leaningStyle = article.leaning === 'left'
        ? 'background-color:rgba(59, 130, 246, 0.2);color:#60a5fa'
        : article.leaning === 'center'
            ? 'background-color:rgba(34, 197, 94, 0.2);color:#4ade80'
            : 'background-color:rgba(244, 63, 94, 0.2);color:#fb7185';

    return `
        <article class="rounded-xl overflow-hidden transition hover:transform hover:scale-[1.02]" style="background-color: var(--bg-tertiary); border: 1px solid var(--border-color);" data-leaning="${article.leaning}">
            ${imgHTML}
            <div class="p-6">
                <h3 class="text-lg font-bold mb-3 transition line-clamp-2 hover:text-blue-400" style="color: var(--text-primary);">
                    <a href="${article.url}" target="_blank" rel="noopener">${article.title}</a>
                </h3>
                <p class="mb-4 text-sm line-clamp-3" style="color: var(--text-secondary);">
                    ${article.content}
                </p>
                <div class="flex items-center justify-between pt-4" style="border-top: 1px solid var(--border-color);">
                    <div class="flex items-center gap-2">
                        <span class="text-xs" style="color: var(--text-muted);">
                            <i class="fas fa-clock mr-1"></i>${article.date}
                        </span>
                        <span class="text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full font-semibold" style="${leaningStyle}">${article.leaning}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <a href="${article.url}" target="_blank" rel="noopener" aria-label="Open article" class="px-3 py-1.5 rounded-lg text-sm transition" style="background-color: var(--accent-blue); color: white;">Read</a>
                        <button data-article-url="${article.url}" title="Save bookmark" aria-pressed="false"
                                onclick="toggleBookmark({title: '${article.title.replace(/'/g, "\\'")}', url: '${article.url}', img: '${article.img || ''}', date: '${article.date}', leaning: '${article.leaning}'})"
                                class="transition hover:text-yellow-500" style="color: var(--text-muted);">
                            <i class="fas fa-bookmark"></i>
                        </button>
                        <button onclick="shareArticle('${article.title.replace(/'/g, "\\'")}', '${article.url}')" class="transition hover:text-blue-400" style="color: var(--text-muted);" title="Share">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </article>
    `;
}

// Share functionality
function shareArticle(title, url) {
    if (navigator.share) {
        navigator.share({
            title: title,
            url: url || window.location.href
        }).catch(err => console.log('Error sharing:', err));
    } else {
        // Fallback: copy to clipboard
        const tempInput = document.createElement('input');
        tempInput.value = window.location.href;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        alert('Link copied to clipboard!');
    }
}

// Intersection Observer for lazy loading images
const imageObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const img = entry.target;
            if (img.dataset.src) {
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
            }
            observer.unobserve(img);
        }
    });
});

document.querySelectorAll('img[data-src]').forEach(img => imageObserver.observe(img));

// Leaning filter
function applyLeaningFilter() {
    const grid = document.getElementById('news-grid');
    if (!grid) return;
    const items = grid.querySelectorAll('article');
    items.forEach(card => {
        const lean = card.getAttribute('data-leaning');
        const match = (currentLeaningFilter === 'all') || (lean === currentLeaningFilter);
        card.style.display = match ? '' : 'none';
    });
}
function updateLeaningControls() {
    document.querySelectorAll('[data-lean-filter]').forEach(btn => {
        const active = btn.getAttribute('data-lean-filter') === currentLeaningFilter;
        btn.classList.toggle('ring-2', active);
        btn.classList.toggle('ring-offset-2', active);
        btn.classList.toggle('ring-blue-500', active);
    });
}
function setLeaningFilter(val) {
    currentLeaningFilter = val;
    applyLeaningFilter();
    updateLeaningControls();
}

// View toggle
function setView(mode) {
    currentView = mode;
    localStorage.setItem('news_view_mode', mode);
    const grid = document.getElementById('news-grid');
    if (!grid) return;
    if (mode === 'list') {
        grid.classList.remove('md:grid-cols-2','lg:grid-cols-3');
        grid.classList.add('grid-cols-1');
    } else {
        grid.classList.add('md:grid-cols-2','lg:grid-cols-3');
        grid.classList.remove('grid-cols-1');
    }
    const gridBtn = document.getElementById('view-grid');
    const listBtn = document.getElementById('view-list');
    if (mode === 'grid') {
        gridBtn.style.backgroundColor = 'var(--accent-blue)';
        gridBtn.style.color = 'white';
        listBtn.style.backgroundColor = 'var(--bg-tertiary)';
        listBtn.style.color = 'var(--text-primary)';
    } else {
        listBtn.style.backgroundColor = 'var(--accent-blue)';
        listBtn.style.color = 'white';
        gridBtn.style.backgroundColor = 'var(--bg-tertiary)';
        gridBtn.style.color = 'var(--text-primary)';
    }
}

// Infinite scroll
let io;
function setupInfiniteScroll() {
    const sentinel = document.getElementById('infinite-scroll-sentinel');
    const btn = document.getElementById('load-more-btn');
    if (!('IntersectionObserver' in window) || !sentinel) { btn.classList.remove('hidden'); return; }
    io = new IntersectionObserver(entries => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                loadMoreNews();
            }
        })
    }, { rootMargin: '200px' });
    io.observe(sentinel);
    // Hide the manual button initially for infinite scroll
    btn.classList.add('hidden');
}

// Initialize controls on load
document.addEventListener('DOMContentLoaded', () => {
    // Set initial view
    setView(currentView);
    // Init leaning filter controls
    updateLeaningControls();
    // Setup infinite scroll
    setupInfiniteScroll();
    // Ensure bookmark icons reflect saved state
    if (typeof updateBookmarkIcons === 'function') updateBookmarkIcons();
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}
